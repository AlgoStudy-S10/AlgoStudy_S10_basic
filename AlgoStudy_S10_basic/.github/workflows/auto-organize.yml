name: Auto Organize Algorithm Files

on:
  push:
    branches:
      - ksm
      - jji
      - ish
      - lkh

jobs:
  organize:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.ksm_token }}
      
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Organize files
        run: |
          # ë¸Œëœì¹˜ ì´ë¦„ì— ë”°ë¥¸ ì´ë¦„ ë§¤í•‘
          case "${{ github.ref_name }}" in
            ksm) NAME="ê¹€ì„¸ë¯¼" ;;
            jji) NAME="ì¥ì§€ì¸" ;;
            ish) NAME="ì„ì„±í˜" ;;
            lkh) NAME="ì´ê²½í˜¸" ;;
            *) echo "Unknown branch"; exit 1 ;;
          esac
          
          # ì»¤ë°‹ ë‚ ì§œë¡œë¶€í„° ì›” ê³„ì‚°
          COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d')
          MONTH=$(date -d "$COMMIT_DATE" +%m 2>/dev/null || date -j -f "%Y-%m-%d" "$COMMIT_DATE" +%m)
          
          # í•´ë‹¹ ì›”ì˜ ì²« ë²ˆì§¸ ë‚  ê³„ì‚°
          YEAR=$(date -d "$COMMIT_DATE" +%Y 2>/dev/null || date -j -f "%Y-%m-%d" "$COMMIT_DATE" +%Y)
          
          # ì£¼ì°¨ ê³„ì‚° (í•´ë‹¹ ì›”ì˜ ëª‡ ë²ˆì§¸ ì£¼ì¸ì§€)
          if date --version >/dev/null 2>&1; then
            # GNU date (Linux)
            COMMIT_DAY=$(date -d "$COMMIT_DATE" +%d)
          else
            # BSD date (macOS)
            COMMIT_DAY=$(date -j -f "%Y-%m-%d" "$COMMIT_DATE" +%d)
          fi
          
          WEEK=$(( (COMMIT_DAY - 1) / 7 + 1 ))
          
          # workspace/ì´ë¦„/thisWeek í´ë” í™•ì¸
          WORKSPACE_DIR="workspace/${NAME}"
          THIS_WEEK_DIR="${WORKSPACE_DIR}/thisWeek"
          
          if [ ! -d "$THIS_WEEK_DIR" ]; then
            echo "âŒ Error: $THIS_WEEK_DIR not found"
            exit 1
          fi
          
          # thisWeek í´ë”ì— Java íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
          JAVA_FILES=$(find "$THIS_WEEK_DIR" -maxdepth 1 -name "*.java" -type f)
          
          if [ -z "$JAVA_FILES" ]; then
            echo "â„¹ï¸  No Java files found in $THIS_WEEK_DIR"
            exit 0
          fi
          
          # ì£¼ì°¨ ì´ë¦„ ìƒì„±
          WEEK_NAME="week${WEEK}"
          TARGET_DIR="${WORKSPACE_DIR}/${MONTH}/${WEEK_NAME}"
          CURRENT_WEEK_DIR="weeklyCode/${WEEK_NAME}"
          mkdir -p "$TARGET_DIR"
          mkdir -p "$CURRENT_WEEK_DIR"
          
          # thisWeek í´ë”ì˜ Java íŒŒì¼ë“¤ì„ ë³µì‚¬
          FILES_COPIED=0
          
          find "$THIS_WEEK_DIR" -maxdepth 1 -name "*.java" -type f | while read -r file; do
            filename=$(basename "$file")
            base_name="${filename%.java}"
            name_with_member="${base_name}_${NAME}.java"
            
            # ì›”/ì£¼ì°¨/ì´ë¦„ í´ë”ì— ë³µì‚¬
            if [ -f "${TARGET_DIR}/${filename}" ]; then
              echo "âš ï¸  File ${filename} already exists in ${TARGET_DIR}, skipping..."
            else
              cp "$file" "${TARGET_DIR}/${filename}"
              echo "âœ… Copied ${filename} to ${TARGET_DIR}"
              FILES_COPIED=$((FILES_COPIED + 1))
            fi
            
            # weeklyCode í´ë”ì— ì´ë¦„ í¬í•¨ëœ íŒŒì¼ëª…ìœ¼ë¡œ ë³µì‚¬
            cp "$file" "${CURRENT_WEEK_DIR}/${name_with_member}"
            echo "ğŸ“‹ Copied ${filename} to ${CURRENT_WEEK_DIR}/${name_with_member}"
          done
          
          # thisWeek í´ë” ë¹„ìš°ê¸°
          rm -f "$THIS_WEEK_DIR"/*.java
          echo "ğŸ—‘ï¸  Cleaned up $THIS_WEEK_DIR"
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          if [ -n "$(git status --porcelain)" ]; then
            git add "$WORKSPACE_DIR/" "weeklyCode/" "$THIS_WEEK_DIR"
            git commit -m "ğŸ“ Auto organize: ${NAME} - ${MONTH}ì›” week${WEEK}"
            
            # main ë¸Œëœì¹˜ë¡œ ì²´í¬ì•„ì›ƒí•˜ê³  ë³‘í•©
            git fetch origin main
            git checkout main
            git merge --no-ff ${{ github.ref_name }} -m "Merge ${NAME}'s solutions for ${MONTH}ì›” week${WEEK}"
            git push origin main
            
            echo "âœ… Files organized and pushed to main branch"
          else
            echo "â„¹ï¸ No changes to commit"
          fi
