name: Auto Organize Algorithm Files

on:
  push:
    branches:
      - ksm
      - jji
      - ish
      - lkh

jobs:
  organize:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Organize files
        run: |
          # ë¸Œëœì¹˜ ì´ë¦„ì— ë”°ë¥¸ ì´ë¦„ ë§¤í•‘
          case "${{ github.ref_name }}" in
            ksm) NAME="ê¹€ì„¸ë¯¼" ;;
            jji) NAME="ì¥ì§€ì¸" ;;
            ish) NAME="ì„ì„±í˜" ;;
            lkh) NAME="ì´ê²½í˜¸" ;;
            *) echo "Unknown branch"; exit 1 ;;
          esac
          
          # ì»¤ë°‹ ë‚ ì§œë¡œë¶€í„° ì›” ê³„ì‚°
          COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d')
          MONTH=$(date -d "$COMMIT_DATE" +%m 2>/dev/null || date -j -f "%Y-%m-%d" "$COMMIT_DATE" +%m)
          
          # í•´ë‹¹ ì›”ì˜ ì²« ë²ˆì§¸ ë‚  ê³„ì‚°
          YEAR=$(date -d "$COMMIT_DATE" +%Y 2>/dev/null || date -j -f "%Y-%m-%d" "$COMMIT_DATE" +%Y)
          
          # ì£¼ì°¨ ê³„ì‚° (í•´ë‹¹ ì›”ì˜ ëª‡ ë²ˆì§¸ ì£¼ì¸ì§€)
          if date --version >/dev/null 2>&1; then
            # GNU date (Linux)
            COMMIT_DAY=$(date -d "$COMMIT_DATE" +%d)
          else
            # BSD date (macOS)
            COMMIT_DAY=$(date -j -f "%Y-%m-%d" "$COMMIT_DATE" +%d)
          fi
          
          WEEK=$(( (COMMIT_DAY - 1) / 7 + 1 ))
          
          # workspace/ì´ë¦„/ í´ë”ê°€ ìˆëŠ”ì§€ í™•ì¸
          WORKSPACE_DIR="workspace/${NAME}"
          
          if [ ! -d "$WORKSPACE_DIR" ]; then
            echo "âŒ Error: $WORKSPACE_DIR not found"
            exit 1
          fi
          
          # workspace/ì´ë¦„/ í´ë” ì•ˆì˜ ëª¨ë“  ì£¼ì°¨ë³„ í´ë” íƒìƒ‰
          FILES_COPIED=0
          
          for week_dir in "$WORKSPACE_DIR"/week*; do
            if [ -d "$week_dir" ]; then
              WEEK_NAME=$(basename "$week_dir")
              TARGET_DIR="${MONTH}/${WEEK_NAME}/${NAME}"
              CURRENT_WEEK_DIR="ê¸ˆì£¼_ì½”ë“œ/${WEEK_NAME}"
              mkdir -p "$TARGET_DIR"
              mkdir -p "$CURRENT_WEEK_DIR"
              
              # í•´ë‹¹ ì£¼ì°¨ í´ë”ì˜ Java íŒŒì¼ë“¤ì„ ë³µì‚¬
              find "$week_dir" -maxdepth 1 -name "*.java" -type f | while read -r file; do
                filename=$(basename "$file")
                base_name="${filename%.java}"
                name_with_member="${base_name}_${NAME}.java"
                
                # ì›”/ì£¼ì°¨/ì´ë¦„ í´ë”ì— ë³µì‚¬
                if [ -f "${TARGET_DIR}/${filename}" ]; then
                  echo "âš ï¸  File ${filename} already exists in ${TARGET_DIR}, skipping..."
                else
                  cp "$file" "${TARGET_DIR}/${filename}"
                  echo "âœ… Copied ${filename} to ${TARGET_DIR}"
                  FILES_COPIED=$((FILES_COPIED + 1))
                fi
                
                # ê¸ˆì£¼_ì½”ë“œ í´ë”ì— ì´ë¦„ í¬í•¨ëœ íŒŒì¼ëª…ìœ¼ë¡œ ë³µì‚¬
                cp "$file" "${CURRENT_WEEK_DIR}/${name_with_member}"
                echo "ğŸ“‹ Copied ${filename} to ${CURRENT_WEEK_DIR}/${name_with_member}"
              done
            fi
          done
          
          if [ $FILES_COPIED -eq 0 ]; then
            echo "â„¹ï¸  No Java files found to copy"
            exit 0
          fi
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          if [ -n "$(git status --porcelain)" ]; then
            git add "${MONTH}/" "ê¸ˆì£¼_ì½”ë“œ/"
            git commit -m "ğŸ“ Auto organize: ${NAME} - ${MONTH}ì›” (${FILES_COPIED}ê°œ íŒŒì¼)"
            
            # main ë¸Œëœì¹˜ë¡œ ì²´í¬ì•„ì›ƒí•˜ê³  ë³‘í•©
            git fetch origin main
            git checkout main
            git merge --no-ff ${{ github.ref_name }} -m "Merge ${NAME}'s solutions for ${MONTH}ì›”"
            git push origin main
            
            echo "âœ… ${FILES_COPIED} files organized and pushed to main branch"
          else
            echo "â„¹ï¸ No changes to commit"
          fi
